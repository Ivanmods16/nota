<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Nota de Pedido - Panambi</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
  h2 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #000; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
  input { width: 90px; text-align: center; }
  .total { font-weight: bold; font-size: 1.2em; margin-top: 10px; }
  .vuelto { font-weight: bold; font-size: 1.2em; color: green; margin-top: 5px; }
  button { margin: 10px 5px; padding: 10px 20px; font-size: 1em; cursor: pointer; }
  .flex { display: flex; gap: 20px; align-items: center; margin-top: 10px; }
</style>
</head>
<body>

<h2>Nota de Pedido</h2>
<p><strong>Empresa:</strong> Panambi</p>

<p>Cliente: <input type="text" id="cliente"></p>
<p>N√∫mero de RUC: <input type="text" id="ruc"></p>
<p>Fecha: <input type="date" id="fecha"></p>

<table id="pedido">
  <thead>
    <tr>
      <th>Cantidad</th>
      <th>Descripci√≥n</th>
      <th>Precio Unitario (‚Ç≤)</th>
      <th>Subtotal (‚Ç≤)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="number" min="0" value="0" oninput="calcularFila(this)"></td>
      <td><input type="text" oninput="agregarFilaSiUltima(this)"></td>
      <td><input type="number" min="0" value="0" oninput="calcularFila(this)"></td>
      <td class="subtotal">0</td>
    </tr>
  </tbody>
</table>

<p class="total">Total: <span id="total">0</span> ‚Ç≤</p>

<div class="flex">
  <label>Monto entregado por el cliente (‚Ç≤): <input type="number" id="entregado" min="0" value="0" oninput="calcularVuelto()"></label>
  <span class="vuelto">Vuelto: ‚Ç≤<span id="vuelto">0</span></span>
</div>

<button onclick="imprimirNota()">üñ®Ô∏è Imprimir / Guardar PDF</button>
<button onclick="enviarWhatsApp()">üí¨ Enviar por WhatsApp</button>

<script>
function calcularFila(elemento) {
  const fila = elemento.parentElement.parentElement;
  const cantidad = parseFloat(fila.cells[0].children[0].value) || 0;
  const precio = parseFloat(fila.cells[2].children[0].value) || 0;
  fila.cells[3].textContent = (cantidad * precio).toLocaleString('es-PY');
  calcularTotal();
}

function calcularTotal() {
  const subtotales = document.querySelectorAll('.subtotal');
  let total = 0;
  subtotales.forEach(celda => total += parseFloat(celda.textContent.replace(/\./g,'')) || 0);
  document.getElementById('total').textContent = total.toLocaleString('es-PY');
  calcularVuelto();
}

function calcularVuelto() {
  const total = parseFloat(document.getElementById('total').textContent.replace(/\./g,'')) || 0;
  const entregado = parseFloat(document.getElementById('entregado').value) || 0;
  let vuelto = entregado - total;
  if(vuelto < 0) vuelto = 0;
  document.getElementById('vuelto').textContent = vuelto.toLocaleString('es-PY');
}

// Agrega una nueva fila si se escribe en la √∫ltima fila
function agregarFilaSiUltima(input) {
  const tbody = document.querySelector('#pedido tbody');
  const filas = tbody.querySelectorAll('tr');
  if(input.parentElement.parentElement === filas[filas.length - 1]) {
    const nuevaFila = filas[0].cloneNode(true);
    nuevaFila.querySelectorAll('input').forEach(i => i.value = i.type === "number" ? 0 : '');
    nuevaFila.querySelector('.subtotal').textContent = "0";
    tbody.appendChild(nuevaFila);
  }
}

function imprimirNota() {
  window.print();
}

function enviarWhatsApp() {
  let cliente = document.getElementById('cliente').value || "Cliente";
  let ruc = document.getElementById('ruc').value || "-";
  let fecha = document.getElementById('fecha').value || "-";
  let total = document.getElementById('total').textContent;
  let entregado = document.getElementById('entregado').value || 0;
  let vuelto = document.getElementById('vuelto').textContent;
  let mensaje = `Nota de Pedido - Panambi\nCliente: ${cliente}\nRUC: ${ruc}\nFecha: ${fecha}\nTotal: ‚Ç≤${total}\nMonto entregado: ‚Ç≤${parseInt(entregado).toLocaleString('es-PY')}\nVuelto: ‚Ç≤${vuelto}\n\nDetalle:\n`;

  const filas = document.querySelectorAll('#pedido tbody tr');
  filas.forEach(fila => {
    let cantidad = fila.cells[0].children[0].value || 0;
    let desc = fila.cells[1].children[0].value || "-";
    let precio = fila.cells[2].children[0].value || 0;
    let subtotal = fila.cells[3].textContent;
    if(cantidad > 0 || desc != "-" || precio > 0) {
      mensaje += `${cantidad} x ${desc} = ‚Ç≤${subtotal}\n`;
    }
  });

  const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
  window.open(url, '_blank');
}
</script>

</body>
</html>
